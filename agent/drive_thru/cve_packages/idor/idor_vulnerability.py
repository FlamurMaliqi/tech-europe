"""
CVE-2024-0007: IDOR (Insecure Direct Object Reference) Vulnerability
VULNERABLE: No authorization check - users can access any user's data
Severity: Medium
DO NOT USE IN PRODUCTION - FOR EDUCATIONAL PURPOSES ONLY
"""

from typing import Dict, Any, List


class IDORVulnerability:
    """VULNERABLE: IDOR vulnerability implementation for lab purposes"""
    
    def __init__(self):
        self.vulnerability_type = "IDOR (Insecure Direct Object Reference)"
        self.cve_id = "CVE-2024-0007"
        self.severity = "Medium"
        self.description = "No authorization check - users can access any user's data"
    
    def vulnerable_get_user_data(self, user_id: int, requesting_user_id: int = None) -> Dict[str, Any]:
        """
        VULNERABLE: Get user data by ID without authorization check
        
        This method demonstrates an IDOR vulnerability where users can
        access other users' data without proper authorization checks.
        
        Args:
            user_id: ID of user whose data to retrieve
            requesting_user_id: ID of user making the request (ignored)
            
        Returns:
            Dictionary with user data
            
        Security Issues:
            - No authorization check
            - Users can access any user's data
            - No ownership verification
        """
        # VULNERABLE: No authorization check - users can access any user's data
        # This allows IDOR attacks where users can access other users' data
        
        # Mock user data
        user_data = {
            "id": user_id,
            "username": f"user{user_id}",
            "email": f"user{user_id}@example.com",
            "phone": f"555-{user_id:04d}",
            "address": f"{user_id} Main St",
            "credit_card": f"****-****-****-{user_id:04d}",
            "ssn": f"***-**-{user_id:04d}",
            "salary": 50000 + (user_id * 1000)
        }
        
        return {
            "user_data": user_data,
            "requesting_user": requesting_user_id,
            "warning": "VULNERABLE: No authorization check - IDOR vulnerability"
        }
    
    def vulnerable_get_order_details(self, order_id: str, requesting_user_id: int = None) -> Dict[str, Any]:
        """
        VULNERABLE: Get order details without authorization check
        
        Args:
            order_id: ID of order to retrieve
            requesting_user_id: ID of user making the request (ignored)
            
        Returns:
            Dictionary with order details
        """
        # VULNERABLE: No authorization check - users can access any order
        # This allows IDOR attacks where users can access other users' orders
        
        # Mock order data
        order_data = {
            "order_id": order_id,
            "customer_id": int(order_id) % 100,
            "items": [
                {"name": "Big Mac", "price": 5.99, "quantity": 1},
                {"name": "Fries", "price": 2.99, "quantity": 2}
            ],
            "total": 11.97,
            "payment_method": "Credit Card",
            "delivery_address": f"{order_id} Oak St",
            "phone": f"555-{int(order_id) % 10000:04d}"
        }
        
        return {
            "order": order_data,
            "requesting_user": requesting_user_id,
            "warning": "VULNERABLE: No authorization check - IDOR vulnerability"
        }
    
    def vulnerable_get_payment_details(self, payment_id: str, requesting_user_id: int = None) -> Dict[str, Any]:
        """
        VULNERABLE: Get payment details without authorization check
        
        Args:
            payment_id: ID of payment to retrieve
            requesting_user_id: ID of user making the request (ignored)
            
        Returns:
            Dictionary with payment details
        """
        # VULNERABLE: No authorization check - users can access any payment
        # This allows IDOR attacks where users can access other users' payment info
        
        # Mock payment data
        payment_data = {
            "payment_id": payment_id,
            "customer_id": int(payment_id) % 100,
            "amount": 25.99,
            "currency": "USD",
            "payment_method": "Credit Card",
            "card_number": f"****-****-****-{int(payment_id) % 10000:04d}",
            "expiry_date": "12/25",
            "cvv": "***",
            "billing_address": f"{payment_id} Pine St",
            "transaction_date": "2024-01-15T10:30:00Z"
        }
        
        return {
            "payment": payment_data,
            "requesting_user": requesting_user_id,
            "warning": "VULNERABLE: No authorization check - IDOR vulnerability"
        }
    
    def vulnerable_get_user_orders(self, user_id: int, requesting_user_id: int = None) -> Dict[str, Any]:
        """
        VULNERABLE: Get user orders without authorization check
        
        Args:
            user_id: ID of user whose orders to retrieve
            requesting_user_id: ID of user making the request (ignored)
            
        Returns:
            Dictionary with user orders
        """
        # VULNERABLE: No authorization check
        orders = [
            {"id": f"order_{user_id}_1", "total": 15.99, "status": "completed"},
            {"id": f"order_{user_id}_2", "total": 22.50, "status": "pending"}
        ]
        
        return {
            "user_id": user_id,
            "orders": orders,
            "requesting_user": requesting_user_id,
            "warning": "VULNERABLE: No authorization check - IDOR vulnerability"
        }


# Global instance for easy import
idor_vulnerability = IDORVulnerability()
